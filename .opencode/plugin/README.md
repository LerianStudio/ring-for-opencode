# Ring OpenCode Plugins

This directory contains TypeScript plugins that port Ring's hook system to OpenCode.

## Plugins Overview

| Plugin | Ring Equivalent | OpenCode Event | Description |
|--------|-----------------|----------------|-------------|
| `session-start.ts` | `session-start.sh` | `session.created` | Context injection at session start |
| `context-injection.ts` | `session-start.sh` (compact) | `experimental.session.compacting` | Preserve context during compaction |
| `session-outcome.ts` | `session-outcome.sh` | `session.compacted`, `session.created` | Prompt for session outcome grade |
| `task-completion-check.ts` | `task-completion-check.sh` | `todo.updated` | Detect all todos complete |
| `outcome-inference.ts` | `outcome_inference.py` | `session.idle` | Infer session outcome |
| `notification.ts` | N/A | `session.idle` | Desktop notifications |
| `doubt-resolver.ts` | N/A | Tool: `ring_doubt` | Ask user to choose from options |

## Event Mapping

| Ring Event | OpenCode Event | Notes |
|------------|----------------|-------|
| `SessionStart` | `session.created` | No matcher support |
| `UserPromptSubmit` | `message.updated` | Workaround via message count tracking; filter user messages only |
| `PostToolUse` | `tool.execute.after` | Filter by `input.tool` (case-insensitive) |
| `PreCompact` | `experimental.session.compacting` | Direct mapping |
| `Stop` | `session.idle` | Fires when AI stops |
| N/A | `session.compacted` | After compaction complete (state-based workaround) |
| N/A | `todo.updated` | Todo list changes |

## State Management

State is persisted in `.opencode/state/`:
- `{key}-{sessionId}.json` format
- Automatic cleanup of files >7 days old
- Atomic writes via temp file + rename with crypto random suffix
- Restrictive permissions (0o600) for sensitive data

### Migration from .ring/state/

Legacy state files in `.ring/state/` are automatically migrated to `.opencode/state/` on session start:
- Migration is safe and idempotent (runs every session, skips already-migrated files)
- Existing files in `.opencode/state/` are never overwritten
- Only `.json` files are migrated

To manually trigger migration or cleanup:
```typescript
import { migrateStateFiles, cleanupLegacyState } from "./utils/state"

// Migrate files (safe to run multiple times)
const result = migrateStateFiles(projectRoot)
console.log(`Migrated: ${result.migrated}, Skipped: ${result.skipped}`)

// Optional: Remove legacy directory after confirming migration
const cleanup = cleanupLegacyState(projectRoot)
if (cleanup.removed) {
  console.log("Legacy .ring/state/ removed")
}
```

## Session ID Handling

Session IDs are obtained from environment variables with secure fallback:
- Primary: `OPENCODE_SESSION_ID`
- Fallback: `CLAUDE_SESSION_ID`
- Secure fallback: Cryptographically random 16-byte hex (no process.ppid)

## Utilities

- `utils/state.ts` - State persistence helpers with path traversal protection
- `utils/message-tracking.ts` - Message count tracking for throttling

## Security Features

- **Path traversal protection**: All file paths validated against project root
- **Command injection prevention**: Uses Bun safe argument interpolation (avoid manual quoting)
- **SQL injection prevention**: Uses `better-sqlite3` with parameterized queries
- **Prompt injection prevention**: Content sanitization before injection
- **Secure temp files**: Crypto random suffix for atomic writes
- **Rate limiting**: Global limit on injections per minute

## Dependencies

**Source of truth:** `.opencode/package.json` (installed into `~/.config/opencode/package.json` by `opencode/installer.sh`).

Defined in `.opencode/package.json`:
- `@opencode-ai/plugin` - OpenCode plugin API (pinned)
- `better-sqlite3` - Safe SQL queries (exact version: 12.6.0)

- `@types/better-sqlite3` - Type definitions
- `@types/node` - Node.js type definitions
- `typescript` - TypeScript compiler

Integrity note: dependency integrity is enforced via `bun.lock` (hashes), generated by `bun install`.

## Testing

Run plugin tests:
```bash
cd opencode/.opencode
bun plugin/test-plugins.ts
```

## Known Limitations

1. **Real context usage**: Context estimation is based on message count, not actual API usage
2. **Event payload structure**: Some payload assumptions require verification against OpenCode's actual events
3. **message.updated double-counting**: Filters to user messages only but payload structure needs verification
